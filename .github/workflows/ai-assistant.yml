name: AI Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  ai-response:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for @kimi mention
        id: check
        run: |
          BODY="${{ github.event.comment.body || github.event.issue.body }}"
          if echo "$BODY" | grep -q "@kimi"; then
            echo "mentioned=true" >> $GITHUB_OUTPUT
          else
            echo "mentioned=false" >> $GITHUB_OUTPUT
          fi

      - name: Send to OpenClaw
        if: steps.check.outputs.mentioned == 'true'
        run: |
          curl -X POST "${{ secrets.OPENCLAW_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENCLAW_TOKEN }}" \
            -d '{
              "event": "${{ github.event_name }}",
              "repository": "${{ github.repository }}",
              "sender": "${{ github.actor }}",
              "issue_number": ${{ github.event.issue.number || github.event.comment.issue_number }},
              "title": "${{ github.event.issue.title || '' }}",
              "body": ${{ toJson(github.event.comment.body || github.event.issue.body) }}
            }'

      - name: Post acknowledgment
        if: steps.check.outputs.mentioned == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **Kimi is thinking...**'
            })