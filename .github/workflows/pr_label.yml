name: Label PRs

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label_pr:
    runs-on: 'ubuntu-24.04'

    steps:
      - name: Check PR and Add Label
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;

            if (prAuthor === 'weblate') {
              const labels = ['translations'];
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

            if (prAuthor === 'Copilot' || prAuthor === 'copilot-swe-agent[bot]') {
              const labels = ['copilot'];
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: labels
                });
              } catch (e) {
                if (e.status !== 422) {
                  // 422 means the label already exists on the PR; anything else is unexpected
                  console.log(`Failed to add copilot label: ${e.status} ${e.message}`);
                }
                // Label may not exist in repo yet; create it then retry
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'copilot',
                  color: '0075ca',
                  description: 'Pull request created by GitHub Copilot'
                }).catch(err => console.log(`createLabel: ${err.status} ${err.message}`));
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: labels
                });
              }
            }
