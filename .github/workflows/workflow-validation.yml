name: Workflow Validation

on:
  push:
    branches: [master, main]
    paths:
      - '.github/workflows/**'
  pull_request:
    branches: [master, main]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-workflows:
    runs-on: 'ubuntu-24.04'
    
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        
      - name: Validate workflow files
        run: |
          echo "=== Validating workflow files ==="
          pip install --quiet pyyaml
          for file in .github/workflows/*.yml .github/workflows/*.yml.disabled; do
            [ -f "$file" ] || continue
            echo "Checking: $file"
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "❌ Invalid YAML: $file"
              exit 1
            fi
            echo "✅ Valid: $file"
          done
          echo ""
          echo "=== All workflow files valid ==="
          
      - name: Check for required secrets
        run: |
          echo "=== Checking workflow secret references ==="
          # List workflows that need secrets
          echo "Workflows requiring secrets:"
          grep -l "secrets\." .github/workflows/*.yml .github/workflows/*.yml.disabled 2>/dev/null | while read file; do
            echo "  - $file"
          done
          echo ""
          echo "✅ Secret check complete"
          
      - name: Validate GitHub Actions syntax
        run: |
          echo "=== Validating GitHub Actions YAML structure ==="
          pip install --quiet pyyaml
          for file in .github/workflows/*.yml .github/workflows/*.yml.disabled; do
            [ -f "$file" ] || continue
            echo "Checking actions syntax: $file"
            # Verify required fields exist in workflow files
            if ! python3 -c "
import yaml, sys
with open('$file') as f:
    doc = yaml.safe_load(f)
if doc is None:
    print('ERROR: Empty document', file=sys.stderr)
    sys.exit(1)
if 'jobs' not in doc:
    print('ERROR: Missing required \"jobs\" key', file=sys.stderr)
    sys.exit(1)
"; then
              echo "❌ Invalid workflow structure: $file"
              exit 1
            fi
            echo "✅ Valid structure: $file"
          done
          echo ""
          echo "=== All workflow structures valid ==="